loc <- "/home/DIDE/ah1114/R/x86_64-pc-linux-gnu-library/3.2/"
.libPaths(c(.libPaths(), loc))

source("data.R")
source("functions.R")
library(shinyBS)

Sys.setlocale('LC_ALL','C')

# setwd("//fi--didenas1.dide.local/yf/Arran/Yellow fever shiny/Test/Streamlining")

#Spinner
mycss <- "
#plot-container {
position: relative;
}
#loading-spinner {
position: absolute;
left: 40%;
top: 50%;
z-index: -1;
margin-top: -450px;  /* half of the spinner's height */
margin-left: -33px; /* half of the spinner's width */
}
#plot.recalculating {
z-index: -2;
}
"

# ui.R
# shinyUI(fluidPage(theme="bootstrap.css",
shinyUI(fluidPage(
  tags$head(includeScript("google-analytics.js")),
  headerPanel(list(HTML('<img src="Imperial.png"/>'),"Yellow fever Immunization coverage across Africa"),
              windowTitle="Yellow Fever Immunization"),
  sidebarPanel(width=4,
               conditionalPanel(condition = "input.conditionedPanels!='3'",
                                selectInput("country",
                                            label = "Choose a country to display",
                                            choices = c("Angola",
                                                        "Benin",
                                                        "Burundi",
                                                        "Burkina Faso",
                                                        "Cameroon",
                                                        "Central African Republic",
                                                        "Chad",
                                                        "Cote d'Ivoire",
                                                        "Democratic Republic of the Congo",
                                                        "Equatorial Guinea",
                                                        "Eritrea",
                                                        "Ethiopia",
                                                        "Gabon",
                                                        "Gambia",
                                                        "Ghana",
                                                        "Guinea",
                                                        "Guinea Bissau",
                                                        "Kenya",
                                                        "Liberia",
                                                        "Mali",
                                                        "Mauritania",
                                                        "Niger",
                                                        "Nigeria",
                                                        "Republic of Congo",
                                                        "Rwanda",
                                                        "Senegal",
                                                        "Sierra Leone",
                                                        "Somalia",
                                                        "South Sudan",
                                                        "Sudan",
                                                        "Tanzania",
                                                        "Togo",
                                                        "Uganda",
                                                        "Zambia"),
                                            selected = "Angola",selectize=FALSE)),
               conditionalPanel(condition = "input.conditionedPanels!='3'",
                                sliderInput("year", label = "Year of interest",
                                            min = 1940, max =2050, value = 2017,sep="",step=1,
                                            # animate= animationOptions(interval=1000,loop=TRUE),
                                            bsPopover("year","Information",content="",placement="right",trigger="hover",option=NA))),
               conditionalPanel(condition = "input.conditionedPanels == '1'", sliderInput("age", label = "Age range of interest",
                                                                                          min = 0, max = 100, value = c(0, 100),
                                                                                          sep = "", step = 1)),
               conditionalPanel(condition = "input.conditionedPanels=='3'",
                                sliderInput("year2",label = "Year of interest",min = 1940, max =2050, value = 2017,sep="",step=1,
                                            bsPopover("year","Information",content="",placement="right",trigger="hover",option=NA)),
                                sliderInput("age2", label = "Age range of interest",
                                            min = 0, max = 100, value = c(0, 100), sep = "", step = 1)),                   
               actionButton("resetSelection", label = "Reset row selection"),
               actionButton("update_range", label = "Update age range"),
               br(),br(),
               conditionalPanel(condition = "input.conditionedPanels=='1'",DT::dataTableOutput("table")),
               conditionalPanel(condition = "input.conditionedPanels=='1'",downloadButton(outputId='downloadtable',label='Download table')),
               
               conditionalPanel(condition = "input.conditionedPanels=='2'",DT::dataTableOutput("table2")),
               conditionalPanel(condition = "input.conditionedPanels=='2'",downloadButton(outputId='downloadtable2',label='Download table')),
               
               conditionalPanel(condition = "input.conditionedPanels=='3'",DT::dataTableOutput("endemictable")),
               conditionalPanel(condition = "input.conditionedPanels=='3'",downloadButton(outputId='downloadendemictable',label='Download endemic table')),
               conditionalPanel(condition = "input.conditionedPanels=='3'",downloadButton(outputId='downloadmapendemic',label='Download endemic map')),
               conditionalPanel(condition = "input.conditionedPanels=='2'",downloadButton(outputId='downloadComb',label='Download vaccination proportion plot')),
               conditionalPanel(condition = "input.conditionedPanels=='2'",downloadButton(outputId='downloadPlot',label='Download vaccination coverage plot')),
               conditionalPanel(condition = "input.conditionedPanels=='1'",downloadButton(outputId='downloadMap',label='Download map'))),
  mainPanel(width=8,
            tabsetPanel(id="conditionedPanels",
                        tabPanel("Country maps",value=1,leafletOutput("map",height=850,width=1000)),
                        tabPanel("Age distribution",value=2,plotlyOutput("plot",height=400,width=1000),
                                 bsPopover("plot", "Information", content=paste0("This graph shows the total population of each 5 year"," age band by vaccination status.","</p><p> Choose from the table to display values."," By default the whole countries values are shown"), placement = "right", trigger = "hover",options = NULL),
                                 plotlyOutput("legend",height=450,width=800),
                                 bsPopover("legend", "Information", content=paste0("This graph shows the vaccination coverage in different"," provinces across ages."," Scroll to see all selected provinces","</p><p> Choose from the table to display values."," By default the country average is shown."), placement = "right", trigger = "hover",options = NULL)),
                        tabPanel("Endemic zone",tabName ="endemic",value=3,leafletOutput("endemicmap",height=850,width=1000),
                                 tags$head(tags$style(HTML(mycss))),
                                 div(id = "plot-container",
                                     tags$img(src = "spinner.gif",
                                              id = "loading-spinner"))),
                        tabPanel("Methodology",value=4,id="conditionedPanels",strong(h2("Summary of methods")),
                                 p("Vaccination coverage was estimated using data from large-scale mass vaccinations in French West Africa during the 1940s to 1960s, outbreak response campaigns since 1970 as reported in the",
                                   a("Weekly Epidemiological Record",href="http://www.who.int/wer/en/",target="_blank"),"(WER) or the",a("WHO disease outbreak news",href="http://www.who.int/csr/don/en/",target="_blank"),"(DON),",
                                   a("WHO-UNICEF estimates of routine infant immunization coverage",href="http://www.who.int/immunization/monitoring_surveillance/routine/coverage/en/index4.html",target="_blank"),
                                   "for yellow fever as part of the",a("Enhanced Programme for Immunisation",href="http://www.wpro.who.int/immunization/en/",target="_blank"),"(EPI), and mass vaccination campaigns in 11 West African countries under the Yellow Fever Initiative and in the Central African Republic from 2006 to 2012."),
                                 p("This data was compiled into a dataset of age-specific vaccination coverage which took into account the year and location of campaigns as well as the demographics of the targeted populations."), 
                                 p("We assumed that vaccination is 100% efficacious and confers lifelong immunity. Furthermore, we assumed no future response or preventive vaccination campaigns, but routine infant immunization coverage to continue at level of the last year provided.",
                                   "Population movements or displacements are not taken into account. In addition to these caveats, accuracy of the vaccination coverage estimates relies on completeness of the records of vaccination activities, as well as accurate estimates of demography, which is uncertain in many African countries.",
                                   "All vaccination activities are implemented at the end of each year, so that the corresponding changes in vaccination coverage will only be visible the following year. For example recent reactive vaccination campaigns conducted in Angola in 2016 are only reflected in the coverage in 2017."),
                                 br(),p("For further reading and a detailed explanation on the methodology, see",strong(a("Garske et al., 2014 PLOS Medicine", href="http://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1001638",target="_blank"))),
                                 br(),p("Vaccination data last updated - January 2018"),
                                 p("If the application appears too zoomed in, hold down the control (command on macs) and - key")),
                        tabPanel("About",value=5,strong(h2("About")),p("POLICI stands for",strong("PO"),"pulation ",strong("L"),"evel ",strong("I"),"mmunization ",strong("C"),"overage ",strong("I"),"mperial",br(),br(),"This tool was developed in order to visualise yellow fever vaccination coverage across the yellow fever endemic zone in Africa.",br(),p("We thank the World Health Organization and countries for providing data on vaccination activities, in particular Sergio Yactayo and Olivier Ronveaux")),br(),strong(h2("Contact Information")),
                                 p(a("Mr Arran Hamlet",href="http://www.imperial.ac.uk/people/arran.hamlet14",target="_blank"),br(),("arran.hamlet14@imperial.ac.uk")),
                                 p(a("Dr Kevin Jean",href="http://www.imperial.ac.uk/people/k.jean",target="_blank"),br(),("k.jean@imperial.ac.uk")),
                                 p(a("Dr Tini Garske",href="http://www.imperial.ac.uk/people/t.garske",target="_blank"),br(),("t.garske@imperial.ac.uk")),
                                 p(strong("MRC Centre for Outbreak Analysis and Modelling",br(),"Department of Infectious Disease Epidemiology",br(),"Imperial College London")))
            )
  )
))



